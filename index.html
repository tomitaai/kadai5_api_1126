<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>聖地巡礼</title>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase.js"></script>
<script type="text/javascript" src="./sample.js"></script> -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">
    <link href='/css/map.css' rel='stylesheet' />
</head>

<body>

    <div id='map'></div>

    <div id="menu">
        <input id="mapbox/satellite-streets-v12" type="radio" name="rtoggle" value="satellite" checked="checked">
        <label for="mapbox/satellite-streets-v12">satellite streets!</label>
        <input id="mapbox/light-v11" type="radio" name="rtoggle" value="light">
        <label for="mapbox/light-v11">light!</label>
        <input id="mapbox/dark-v11" type="radio" name="rtoggle" value="dark">
        <label for="mapbox/dark-v11">dark!</label>
        <input id="mapbox/streets-v12" type="radio" name="rtoggle" value="streets">
        <label for="mapbox/streets-v12">streets!</label>
        <input id="mapbox/outdoors-v12" type="radio" name="rtoggle" value="outdoors">
        <label for="mapbox/outdoors-v12">outdoors!</label>
    </div>

    <div class="insert">
        <label for="name">name</label>
        <input id="name" type="text" placeholder="地名">
        <label for="address">address</label>
        <input id="address" type="text" placeholder="住所">

        <button id="insBtn">写真投稿に全集中</button>
    </div>



    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        import {
            getStorage,
            ref as sRef,
            uploadBytesResumable,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";

        import {
            getFirestore,
            doc,
            getDocs,
            setDoc,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            deleteField
        } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";

        const db = getFirestore();
        const dbRef = collection(db, "monument");
        console.log(db);
        console.log(dbRef);




        mapboxgl.accessToken = 'pk.eyJ1IjoidG9taXRhMTAzIiwiYSI6ImNsYXprd2VwZjB0c20zdW11ZnByM2Z6dnMifQ.dot9ijsx8Hd4a7x2RQw_rw';


        // ＝＝＝＝ユーザーの現在地を取得して画面の中心に配置＝＝＝＝
        navigator.geolocation.getCurrentPosition(function (position) { // 現在地取得
            var lng = position.coords.longitude;
            var lat = position.coords.latitude;
            mapView(lng, lat);
        });
        function mapView(lng, lat) {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/tomita103/clb2dcsc3001p15mq2tssfw3t', // 日本語スタイル
                center: [lng, lat],
                zoom: 6
            });


            // ＝＝＝＝現在位置表示コントロール＝＝＝＝

            map.addControl(
                new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    // When active the map will receive updates to the device's location as it changes.
                    trackUserLocation: true,
                    // Draw an arrow next to the location dot to indicate which direction the device is heading.
                    showUserHeading: true
                })
            );


            // ＝＝＝＝聖地を地図上に表示＝＝＝＝
            // 公式サイトのコード
            // https://firebase.google.com/docs/firestore/query-data/get-data#web
            // の「コレクションから複数のドキュメントを取得する」を参照したうえで追記してるもの

            async function monumentView(){
            const querySnapshot = await getDocs(collection(db, "monument"));
            querySnapshot.forEach((doc) => {
                console.log(doc.id, " => ", doc.data());
                console.log(doc.data().name);
                console.log(doc.data().address);
            });
            }
            monumentView();
            // 公式サイトのコード終了


            // １つの地点だけ表示させるコード
            // （これを元にfirebaseから引っ張った複数地点を入れ込みたいです）

            const monument = [139.7670516, 35.6811673];
            const popup = new mapboxgl.Popup({ offset: 25 }).setText(
                'Construction on the Washington Monument began in 1848.'
            );

            const el = document.createElement('div');
            el.id = 'marker';

            // create the marker
            new mapboxgl.Marker(el)
                .setLngLat(monument)
                .setPopup(popup)
                .addTo(map);



            // ＝＝＝＝投稿＝＝＝＝
            let name = document.getElementById("name");
            let address = document.getElementById("address");

            async function AddDocument_CustomID() {
                let ref = collection(db, "monument");
                const docRef = await addDoc(
                    ref, {
                    name: name.value,
                    address: address.value
                }
                )
                    .then(() => {
                        alert("心を燃やせ！写真は燃やすなキケン！");
                        function clearText() {
                            name.value = '';
                            address.value = '';
                        }
                        clearText();
                    })
                    .catch((error) => {
                        alert("エラー" + error);
                    })
            }

            // ボタンクリックイベント

            insBtn.addEventListener("click", AddDocument_CustomID);








            // ＝＝＝＝画像を投稿＝＝＝＝







            // ＝＝＝＝マップのスタイルを選択＝＝＝＝
            const layerList = document.getElementById('menu');
            const inputs = layerList.getElementsByTagName('input');
            for (const input of inputs) {
                input.onclick = (layer) => {
                    const layerId = layer.target.id;
                    map.setStyle('mapbox://styles/' + layerId);
                };
            }
            // ＝＝＝＝＝＝＝＝＝＝＝＝



            // class customMarker extends mapboxgl.Marker{
            //     _onMapClick(e) {
            //         const targetElement = e.originalEvent.target;
            //         const element = this._element;

            //         if (targetElement === element || element.contains((targetElement))) {
            //             clickEvent();
            //         }
            //     }
            // }

            // const marker = new customMarker({
            // 	color: '#ff0000'
            // 	})
            // 	.setLngLat(marker_loc)
            // 	.addTo(gmap);



        }
    </script>


</body>

</html>